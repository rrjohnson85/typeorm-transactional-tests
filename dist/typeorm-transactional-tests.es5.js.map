{"version":3,"file":"typeorm-transactional-tests.es5.js","sources":["../src/queryRunnerWrapper.ts","../src/transactionalTestContext.ts"],"sourcesContent":["/**\n * Wraps the original TypeORM query runner to intercept some calls\n * and manipulate the transactional context.\n */\nimport { QueryRunner } from 'typeorm';\n\ninterface QueryRunnerWrapper extends QueryRunner {\n  releaseQueryRunner(): Promise<void>;\n}\n\nlet release: () => Promise<void>;\n\nconst wrap = (originalQueryRunner: QueryRunner): QueryRunnerWrapper => {\n  release = originalQueryRunner.release;\n  originalQueryRunner.release = () => {\n    return Promise.resolve();\n  };\n\n  (originalQueryRunner as QueryRunnerWrapper).releaseQueryRunner = () => {\n    originalQueryRunner.release = release;\n    return originalQueryRunner.release();\n  };\n\n  return originalQueryRunner as QueryRunnerWrapper;\n};\n\nexport { QueryRunnerWrapper, wrap };\n","import { Connection } from 'typeorm';\nimport { QueryRunnerWrapper, wrap } from './queryRunnerWrapper';\n\nexport default class TransactionalTestContext {\n  private queryRunner: QueryRunnerWrapper | null = null;\n  private originQueryRunnerFunction: any;\n\n  constructor(private readonly connection: Connection) {}\n\n  async start(): Promise<void> {\n    if (this.queryRunner) {\n      throw new Error('Context already started');\n    }\n\n    try {\n      this.queryRunner = this.buildWrappedQueryRunner();\n      this.monkeyPatchQueryRunnerCreation(this.queryRunner);\n\n      await this.queryRunner.connect();\n      await this.queryRunner.startTransaction();\n    } catch (error) {\n      await this.cleanUpResources();\n      throw error;\n    }\n  }\n\n  async finish(): Promise<void> {\n    if (!this.queryRunner) {\n      throw new Error('Context not started. You must call \"start\" before finishing it.');\n    }\n    try {\n      await this.queryRunner.rollbackTransaction();\n      this.restoreQueryRunnerCreation();\n    } finally {\n      await this.cleanUpResources();\n    }\n  }\n\n  private buildWrappedQueryRunner(): QueryRunnerWrapper {\n    const queryRunner = this.connection.createQueryRunner();\n    return wrap(queryRunner);\n  }\n\n  private monkeyPatchQueryRunnerCreation(queryRunner: QueryRunnerWrapper): void {\n    const patch = () => Promise.resolve();\n    this.originQueryRunnerFunction = Connection.prototype.createQueryRunner;\n\n    Connection.prototype.createQueryRunner = () => ({\n      ...queryRunner,\n      startTransaction: patch,\n      commitTransaction: patch,\n      rollbackTransaction: patch,\n      release: patch,\n    });\n  }\n\n  private restoreQueryRunnerCreation(): void {\n    Connection.prototype.createQueryRunner = this.originQueryRunnerFunction;\n  }\n\n  private async cleanUpResources(): Promise<void> {\n    if (this.queryRunner) {\n      await this.queryRunner.releaseQueryRunner();\n      this.queryRunner = null;\n    }\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAUA,IAAI,OAA4B,CAAC;AAEjC,IAAM,IAAI,GAAG,UAAC,mBAAgC;IAC5C,OAAO,GAAG,mBAAmB,CAAC,OAAO,CAAC;IACtC,mBAAmB,CAAC,OAAO,GAAG;QAC5B,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;KAC1B,CAAC;IAED,mBAA0C,CAAC,kBAAkB,GAAG;QAC/D,mBAAmB,CAAC,OAAO,GAAG,OAAO,CAAC;QACtC,OAAO,mBAAmB,CAAC,OAAO,EAAE,CAAC;KACtC,CAAC;IAEF,OAAO,mBAAyC,CAAC;CAClD,CAAC;;ACrBF;IAIE,kCAA6B,UAAsB;QAAtB,eAAU,GAAV,UAAU,CAAY;QAH3C,gBAAW,GAA8B,IAAI,CAAC;KAGC;IAEjD,wCAAK,GAAX;;;;;;wBACE,IAAI,IAAI,CAAC,WAAW,EAAE;4BACpB,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;yBAC5C;;;;wBAGC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,uBAAuB,EAAE,CAAC;wBAClD,IAAI,CAAC,8BAA8B,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;wBAEtD,qBAAM,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAA;;wBAAhC,SAAgC,CAAC;wBACjC,qBAAM,IAAI,CAAC,WAAW,CAAC,gBAAgB,EAAE,EAAA;;wBAAzC,SAAyC,CAAC;;;;wBAE1C,qBAAM,IAAI,CAAC,gBAAgB,EAAE,EAAA;;wBAA7B,SAA6B,CAAC;wBAC9B,MAAM,OAAK,CAAC;;;;;KAEf;IAEK,yCAAM,GAAZ;;;;;wBACE,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;4BACrB,MAAM,IAAI,KAAK,CAAC,iEAAiE,CAAC,CAAC;yBACpF;;;;wBAEC,qBAAM,IAAI,CAAC,WAAW,CAAC,mBAAmB,EAAE,EAAA;;wBAA5C,SAA4C,CAAC;wBAC7C,IAAI,CAAC,0BAA0B,EAAE,CAAC;;4BAElC,qBAAM,IAAI,CAAC,gBAAgB,EAAE,EAAA;;wBAA7B,SAA6B,CAAC;;;;;;KAEjC;IAEO,0DAAuB,GAA/B;QACE,IAAM,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,iBAAiB,EAAE,CAAC;QACxD,OAAO,IAAI,CAAC,WAAW,CAAC,CAAC;KAC1B;IAEO,iEAA8B,GAAtC,UAAuC,WAA+B;QACpE,IAAM,KAAK,GAAG,cAAM,OAAA,OAAO,CAAC,OAAO,EAAE,GAAA,CAAC;QACtC,IAAI,CAAC,yBAAyB,GAAG,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC;QAExE,UAAU,CAAC,SAAS,CAAC,iBAAiB,GAAG,cAAM,8BAC1C,WAAW,KACd,gBAAgB,EAAE,KAAK,EACvB,iBAAiB,EAAE,KAAK,EACxB,mBAAmB,EAAE,KAAK,EAC1B,OAAO,EAAE,KAAK,OACd,CAAC;KACJ;IAEO,6DAA0B,GAAlC;QACE,UAAU,CAAC,SAAS,CAAC,iBAAiB,GAAG,IAAI,CAAC,yBAAyB,CAAC;KACzE;IAEa,mDAAgB,GAA9B;;;;;6BACM,IAAI,CAAC,WAAW,EAAhB,wBAAgB;wBAClB,qBAAM,IAAI,CAAC,WAAW,CAAC,kBAAkB,EAAE,EAAA;;wBAA3C,SAA2C,CAAC;wBAC5C,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;;;;;;KAE3B;IACH,+BAAC;CAAA,IAAA;;;;"}