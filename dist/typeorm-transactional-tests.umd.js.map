{"version":3,"file":"typeorm-transactional-tests.umd.js","sources":["../src/queryRunnerWrapper.ts","../src/transactionalTestContext.ts"],"sourcesContent":["/**\n * Wraps the original TypeORM query runner to intercept some calls\n * and manipulate the transactional context.\n */\nimport { QueryRunner } from 'typeorm';\n\ninterface QueryRunnerWrapper extends QueryRunner {\n  releaseQueryRunner(): Promise<void>;\n}\n\nlet release: () => Promise<void>;\n\nconst wrap = (originalQueryRunner: QueryRunner): QueryRunnerWrapper => {\n  release = originalQueryRunner.release;\n  originalQueryRunner.release = () => {\n    return Promise.resolve();\n  };\n\n  (originalQueryRunner as QueryRunnerWrapper).releaseQueryRunner = () => {\n    originalQueryRunner.release = release;\n    return originalQueryRunner.release();\n  };\n\n  return originalQueryRunner as QueryRunnerWrapper;\n};\n\nexport { QueryRunnerWrapper, wrap };\n","import { Connection } from 'typeorm';\nimport { QueryRunnerWrapper, wrap } from './queryRunnerWrapper';\n\nexport default class TransactionalTestContext {\n  private queryRunner: QueryRunnerWrapper | null = null;\n  private originQueryRunnerFunction: any;\n\n  constructor(private readonly connection: Connection) {}\n\n  async start(): Promise<void> {\n    if (this.queryRunner) {\n      throw new Error('Context already started');\n    }\n\n    try {\n      this.queryRunner = this.buildWrappedQueryRunner();\n      this.monkeyPatchQueryRunnerCreation(this.queryRunner);\n\n      await this.queryRunner.connect();\n      await this.queryRunner.startTransaction();\n    } catch (error) {\n      await this.cleanUpResources();\n      throw error;\n    }\n  }\n\n  async finish(): Promise<void> {\n    if (!this.queryRunner) {\n      throw new Error('Context not started. You must call \"start\" before finishing it.');\n    }\n    try {\n      await this.queryRunner.rollbackTransaction();\n      this.restoreQueryRunnerCreation();\n    } finally {\n      await this.cleanUpResources();\n    }\n  }\n\n  private buildWrappedQueryRunner(): QueryRunnerWrapper {\n    const queryRunner = this.connection.createQueryRunner();\n    return wrap(queryRunner);\n  }\n\n  private monkeyPatchQueryRunnerCreation(queryRunner: QueryRunnerWrapper): void {\n    const patch = () => Promise.resolve();\n    this.originQueryRunnerFunction = Connection.prototype.createQueryRunner;\n\n    Connection.prototype.createQueryRunner = () => ({\n      ...queryRunner,\n      startTransaction: patch,\n      commitTransaction: patch,\n      rollbackTransaction: patch,\n      release: patch,\n    });\n  }\n\n  private restoreQueryRunnerCreation(): void {\n    Connection.prototype.createQueryRunner = this.originQueryRunnerFunction;\n  }\n\n  private async cleanUpResources(): Promise<void> {\n    if (this.queryRunner) {\n      await this.queryRunner.releaseQueryRunner();\n      this.queryRunner = null;\n    }\n  }\n}\n"],"names":["Connection"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAUA,IAAI,OAA4B,CAAC;IAEjC,IAAM,IAAI,GAAG,UAAC,mBAAgC;QAC5C,OAAO,GAAG,mBAAmB,CAAC,OAAO,CAAC;QACtC,mBAAmB,CAAC,OAAO,GAAG;YAC5B,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;SAC1B,CAAC;QAED,mBAA0C,CAAC,kBAAkB,GAAG;YAC/D,mBAAmB,CAAC,OAAO,GAAG,OAAO,CAAC;YACtC,OAAO,mBAAmB,CAAC,OAAO,EAAE,CAAC;SACtC,CAAC;QAEF,OAAO,mBAAyC,CAAC;IACnD,CAAC,CAAC;;ICrBF;QAIE,kCAA6B,UAAsB;YAAtB,eAAU,GAAV,UAAU,CAAY;YAH3C,gBAAW,GAA8B,IAAI,CAAC;SAGC;QAEjD,wCAAK,GAAX;;;;;;4BACE,IAAI,IAAI,CAAC,WAAW,EAAE;gCACpB,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;6BAC5C;;;;4BAGC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,uBAAuB,EAAE,CAAC;4BAClD,IAAI,CAAC,8BAA8B,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;4BAEtD,qBAAM,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAA;;4BAAhC,SAAgC,CAAC;4BACjC,qBAAM,IAAI,CAAC,WAAW,CAAC,gBAAgB,EAAE,EAAA;;4BAAzC,SAAyC,CAAC;;;;4BAE1C,qBAAM,IAAI,CAAC,gBAAgB,EAAE,EAAA;;4BAA7B,SAA6B,CAAC;4BAC9B,MAAM,OAAK,CAAC;;;;;SAEf;QAEK,yCAAM,GAAZ;;;;;4BACE,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;gCACrB,MAAM,IAAI,KAAK,CAAC,iEAAiE,CAAC,CAAC;6BACpF;;;;4BAEC,qBAAM,IAAI,CAAC,WAAW,CAAC,mBAAmB,EAAE,EAAA;;4BAA5C,SAA4C,CAAC;4BAC7C,IAAI,CAAC,0BAA0B,EAAE,CAAC;;gCAElC,qBAAM,IAAI,CAAC,gBAAgB,EAAE,EAAA;;4BAA7B,SAA6B,CAAC;;;;;;SAEjC;QAEO,0DAAuB,GAA/B;YACE,IAAM,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,iBAAiB,EAAE,CAAC;YACxD,OAAO,IAAI,CAAC,WAAW,CAAC,CAAC;SAC1B;QAEO,iEAA8B,GAAtC,UAAuC,WAA+B;YACpE,IAAM,KAAK,GAAG,cAAM,OAAA,OAAO,CAAC,OAAO,EAAE,GAAA,CAAC;YACtC,IAAI,CAAC,yBAAyB,GAAGA,kBAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC;YAExEA,kBAAU,CAAC,SAAS,CAAC,iBAAiB,GAAG,cAAM,8BAC1C,WAAW,KACd,gBAAgB,EAAE,KAAK,EACvB,iBAAiB,EAAE,KAAK,EACxB,mBAAmB,EAAE,KAAK,EAC1B,OAAO,EAAE,KAAK,OACd,CAAC;SACJ;QAEO,6DAA0B,GAAlC;YACEA,kBAAU,CAAC,SAAS,CAAC,iBAAiB,GAAG,IAAI,CAAC,yBAAyB,CAAC;SACzE;QAEa,mDAAgB,GAA9B;;;;;iCACM,IAAI,CAAC,WAAW,EAAhB,wBAAgB;4BAClB,qBAAM,IAAI,CAAC,WAAW,CAAC,kBAAkB,EAAE,EAAA;;4BAA3C,SAA2C,CAAC;4BAC5C,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;;;;;;SAE3B;QACH,+BAAC;IAAD,CAAC,IAAA;;;;;;;;;;;;"}